"use strict";(self.webpackChunkcasecon_frontend=self.webpackChunkcasecon_frontend||[]).push([[241],{241:(e,t,n)=>{n.r(t),n.d(t,{default:()=>h});var a=n(43),r=n(636);const s="http://localhost:5000/uids",o="nameIdMap",i="nameIdMapQueue";async function l(){try{if(!(await fetch(s,{method:"GET",headers:{Accept:"application/json"}})).ok)throw new Error("Not OK");return!0}catch(e){return!1}}async function c(e){return await l()?(await d(),await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),window.localStorage.setItem(o,JSON.stringify(e)),!0):(window.localStorage.setItem(o,JSON.stringify(e)),function(e){let t=JSON.parse(window.localStorage.getItem(i)||"[]");t.push(e),window.localStorage.setItem(i,JSON.stringify(t))}(e),!1)}async function d(){let e=JSON.parse(window.localStorage.getItem(i)||"[]");if(0!==e.length){for(const t of e)await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});window.localStorage.removeItem(i)}}var u=n(579);function m(e){return(e||"").trim().replace(/\s+/g," ").toLowerCase()}function g(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"MAST",n=0;e.forEach(e=>{const t=e.match(/UID-(\d+)-/);t&&(n=Math.max(n,parseInt(t[1],10)))});return`UID-${String(n+1).padStart(4,"0")}-${t}`}function h(e){let{bucaNames:t=[],jovieNames:n=[],bucaCaregivers:d=[],jovieCaregivers:h=[],initialNameMap:p={},onNameMapChange:f,showIDs:v=!0,allowAdmin:x=!0}=e;const[b,w]=(0,a.useState)(p),[y,j]=(0,a.useState)("client"),S=(0,r.W)(),N=(0,r.W)(e=>e.channels);(0,a.useEffect)(()=>{let e=!0;return(async()=>{try{const t=await async function(){if(await l()){const e=await fetch(s);if(!e.ok)throw new Error("Failed to fetch from backend");const t=await e.json();return window.localStorage.setItem(o,JSON.stringify(t)),t}{const e=window.localStorage.getItem(o);return e?JSON.parse(e):{}}}().catch(()=>p||{});if(!e)return;w(t),f&&f(t);try{window.saveNameIdMap&&window.saveNameIdMap(t)}catch{}try{S.publish("uids",{map:t,loadedAt:(new Date).toISOString()})}catch{}R(!0)}catch{if(!e)return;w(p||{}),R(!0)}})(),()=>{e=!1}},[]);const[I,C]=(0,a.useState)(""),[A,E]=(0,a.useState)(""),[O,k]=(0,a.useState)([]),[M,$]=(0,a.useState)(""),[T,D]=(0,a.useState)(""),[U,J]=(0,a.useState)(""),[B,L]=(0,a.useState)(""),[P,R]=(0,a.useState)(!1),[W,V]=(0,a.useState)(null);(0,a.useEffect)(()=>{try{S.publish("uids",{map:b,updatedAt:(new Date).toISOString()})}catch(e){}},[b]),(0,a.useEffect)(()=>{let e=!1;async function t(){try{const t=await l();e||V(t)}catch{e||V(!1)}}t();const n=setInterval(t,15e3);return()=>{e=!0,clearInterval(n)}},[]);const X=e=>`${y}:${m(e)}`,_=e=>e.startsWith(y+":"),F=e=>{const t=String(e||"").trim();if(!t)return[];const n=m(t),a=new Set([n]),r=n.replace(/[\-\.']/g," ");a.add(r),a.add(r.replace(/\s+/g,"")),a.add(n.replace(/\s+/g," "));const s=n.match(/"([^"]+)"/);if(s){const e=s[1].toLowerCase().trim();let t=n.replace(/"[^"]+"/g,"").replace(/\s+/g," ").trim();t&&a.add(t);const r=t.split(/\s+/).filter(Boolean),o=r[r.length-1];o&&a.add(`${e} ${o}`.trim()),a.add(e)}const o=n.split(/\s+/).filter(Boolean);o.length>1&&a.add(o.slice(0,-1).join(" "));const i=n.replace(/[",\.]/g,"").replace(/\s+/g," ").trim();return i&&a.add(i),Array.from(a).filter(Boolean)};function q(e,t,n){const a={...e};return F(t).forEach(e=>{const t=m(e);a[`client:${t}`]=n,a[`caregiver:${t}`]=n}),a}function G(e){const t=new Set,n=[];for(const a of e||[]){const e=m(a);t.has(e)||(t.add(e),n.push(a))}return n}function K(e,t){const n=(null===e||void 0===e?void 0:e.rows)||[];if("client"===t)return n.map(e=>null===e||void 0===e?void 0:e.client).filter(Boolean);{const e=[];return n.forEach(t=>{null!==t&&void 0!==t&&t.caregiver&&(Array.isArray(t.caregiver)?t.caregiver.forEach(t=>{t&&("string"===typeof t?e.push(t):"object"===typeof t&&t.name&&e.push(String(t.name)))}):"object"===typeof t.caregiver&&t.caregiver.name?e.push(String(t.caregiver.name)):String(t.caregiver||"").split(",").map(e=>e.trim()).forEach(t=>t&&e.push(t)))}),e}}const Q=K(null===N||void 0===N?void 0:N.buca,y)||[],Y=K(null===N||void 0===N?void 0:N.jovie,y)||[],z="client"===y?t||[]:d||[],H="client"===y?n||[]:h||[],Z=G(Q.length?Q:z),ee=G(Y.length?Y:H);function te(e){const t=new Set,n=[];for(const a of e){const e=m(a.name);t.has(e)||(t.add(e),n.push(a))}return n}(0,a.useEffect)(()=>{console.debug("[UIDRegistry] Derived BUCA live names",{entityType:y,fromChannelsCount:Q.length,fromPropsCount:z.length,finalCount:Z.length}),console.debug("[UIDRegistry] Derived JOVIE live names",{entityType:y,fromChannelsCount:Y.length,fromPropsCount:H.length,finalCount:ee.length})},[y]);const ne=te([...Z.map(e=>({name:e,uid:b[X(e)]})).filter(e=>{return"string"===typeof(t=e.uid)&&/-BUCA$/.test(t);var t})]).filter(e=>e.name.toLowerCase().includes(T.toLowerCase())),ae=te([...ee.map(e=>({name:e,uid:b[X(e)]})).filter(e=>{return"string"===typeof(t=e.uid)&&/-JOVIE$/.test(t);var t})]).filter(e=>e.name.toLowerCase().includes(U.toLowerCase()));(0,a.useEffect)(()=>{const e={};Object.entries(b).forEach(t=>{let[n,a]=t;_(n)&&(e[a]||(e[a]=new Set),e[a].add(n.split(":")[1]))});const a=(Y.length?Y:H)||[],r=(Q.length?Q:z)||[],s=Object.entries(e).map(e=>{let[s,o]=e;const i=Array.from(o),l=a.find(e=>i.includes(m(e))),c=r.find(e=>i.includes(m(e))),u=l||c||null,g=[];return u&&g.push(u),i.forEach(e=>{const s=a.find(t=>m(t)===e),o=r.find(t=>m(t)===e),i=s||o||function(e){const a=[..."client"===y?[t,n]:[d,h]];for(const t of a){const n=(t||[]).find(t=>m(t)===e);if(n)return n}return e.split(" ").filter(Boolean).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}(e);g.some(e=>m(e)===m(i))||g.push(i)}),{uid:s,names:g}});k(s)},[b,y]);const re=(e,t)=>{var n;if(!P)return!1;if(console.log(`Processing ${t} data:`,e),null===e||void 0===e||null===(n=e.rows)||void 0===n||!n.length)return console.log(`No rows in ${t} data`),!1;try{var a;const n=[];if(("buca"===t||"jovie"===t)&&("client"===y?e.rows.forEach(e=>e.client&&n.push(e.client)):e.rows.forEach(e=>{e.caregiver&&(Array.isArray(e.caregiver)?e.caregiver.forEach(e=>{e&&("string"===typeof e?n.push(e):"object"===typeof e&&e.name&&n.push(String(e.name)))}):"object"===typeof e.caregiver&&e.caregiver.name?n.push(String(e.caregiver.name)):String(e.caregiver||"").split(",").map(e=>e.trim()).forEach(e=>e&&n.push(e)))})),console.log(`Extracted ${n.length} ${y} names from ${t}:`,n),0===n.length)return console.log(`No valid ${y} names found in ${t} data`),!1;const i={...b};let l=!1;const c=new Set(Object.entries(i).filter(e=>{let[t]=e;return _(t)}).map(e=>{let[,t]=e;return t})),d=e=>"string"===typeof e&&/-MAST$/.test(e),u="buca"===t?"jovie":"jovie"===t?"buca":null,h=u?null===(a=r.W.getState().channels)||void 0===a?void 0:a[u]:null,p=new Set(((null===h||void 0===h?void 0:h.rows)||[]).flatMap(e=>"client"===y?e.client?[e.client]:[]:e.caregiver?Array.isArray(e.caregiver)?e.caregiver:String(e.caregiver||"").split(",").map(e=>e.trim()):[]).map(e=>m(e))),v="buca"===t?"BUCA":"jovie"===t?"JOVIE":"MAST";Array.from(c).some(e=>d(e));var s,o;return n.forEach(e=>{const t=m(e),n=`${y}:${t}`,a=i[n],r=function(e,t){const n=F(t).map(e=>m(e)),a=[];n.forEach(e=>{a.push(`client:${e}`),a.push(`caregiver:${e}`)});let r=[];for(const s of a){const t=e[s];t&&r.push(t)}return 0===r.length?null:r.find(e=>"string"===typeof e&&/-MAST$/.test(e))||r[0]}(i,e);if(!a||!d(a)){if(r&&(!a||!d(a)&&a!==r))return i[n]=r,void(l=!0);if(!a||!d(a)){if(a&&!d(a)&&p.has(t)){const e=g(c,"MAST");return Object.keys(i).forEach(t=>{_(t)&&i[t]===a&&(i[t]=e)}),i[n]=e,c.add(e),void(l=!0)}if(!a)if(p.has(t)){const t=g(c,"MAST");i[n]=t,c.add(t),l=!0,console.log("Assigned MAST UID (both sources present):",{name:e,key:n,uid:t})}else{const t=g(c,v);i[n]=t,c.add(t),l=!0,console.log("Assigned temporary UID:",{name:e,key:n,uid:t})}}}}),l?(console.log("Updating name map with changes from",t),w(i),null===f||void 0===f||f(i),null===(s=(o=window).saveNameIdMap)||void 0===s||s.call(o,i),!0):(console.log("No changes to name map from",t),!1)}catch(i){return console.error(`Error processing ${t} data:`,i),!1}};return(0,a.useEffect)(()=>{console.log("Setting up exchange subscriptions for entityType:",y);try{if(P){const{channels:e}=r.W.getState();null!==e&&void 0!==e&&e.buca&&re(e.buca,"buca"),null!==e&&void 0!==e&&e.jovie&&re(e.jovie,"jovie")}}catch(t){console.warn("Failed to process initial exchange channels:",t)}const e=r.W.subscribe((e,n)=>{try{var a,r,s,o,i,l;if(!P)return;(null===(a=e.channels)||void 0===a?void 0:a.buca)!==(null===(r=n.channels)||void 0===r?void 0:r.buca)&&null!==(s=e.channels)&&void 0!==s&&s.buca&&re(e.channels.buca,"buca"),(null===(o=e.channels)||void 0===o?void 0:o.jovie)!==(null===(i=n.channels)||void 0===i?void 0:i.jovie)&&null!==(l=e.channels)&&void 0!==l&&l.jovie&&re(e.channels.jovie,"jovie")}catch(t){console.warn("Error handling exchange update:",t)}});return()=>e()},[y,P]),(0,a.useEffect)(()=>{try{null!==N&&void 0!==N&&N.buca&&re(N.buca,"buca")}catch(e){}},[null===N||void 0===N?void 0:N.buca,y]),(0,a.useEffect)(()=>{try{null!==N&&void 0!==N&&N.jovie&&re(N.jovie,"jovie")}catch(e){}},[null===N||void 0===N?void 0:N.jovie,y]),(0,u.jsx)("div",{className:"flex justify-center w-full min-h-[80vh] items-start",children:(0,u.jsxs)("div",{className:"w-full max-w-3xl bg-white shadow-xl rounded-2xl p-8 mt-8 mb-8 border border-gray-200",children:[(0,u.jsx)("h2",{className:"text-2xl font-bold mb-6 text-center text-blue-800 tracking-tight",children:"UID Registry"}),(0,u.jsxs)("div",{className:"flex justify-center mb-6",children:[(0,u.jsx)("button",{className:"px-4 py-2 rounded-l "+("client"===y?"bg-blue-600 text-white":"bg-gray-200 text-gray-700"),onClick:()=>j("client"),children:"Clients"}),(0,u.jsx)("button",{className:"px-4 py-2 rounded-r "+("caregiver"===y?"bg-blue-600 text-white":"bg-gray-200 text-gray-700"),onClick:()=>j("caregiver"),children:"Caregivers"})]}),(0,u.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 mb-6",children:[(0,u.jsxs)("div",{children:[(0,u.jsx)("label",{className:"block text-xs font-semibold mb-1 text-gray-700",children:"BUCA Names"}),(0,u.jsx)("input",{className:"mb-1 w-full border px-1 text-xs rounded focus:ring-2 focus:ring-blue-200",placeholder:"Search...",value:T,onChange:e=>D(e.target.value)}),(0,u.jsx)("ul",{id:"nameid-buca-list",className:"border rounded h-40 overflow-y-auto bg-gray-50 text-sm",children:ne.map((e,t)=>{let{name:n,uid:a}=e;return(0,u.jsxs)("li",{className:"px-2 py-1 cursor-pointer hover:bg-orange-100 "+(I===n?"bg-orange-200":""),onClick:()=>C(n),title:n,children:[(0,u.jsx)("span",{className:"truncate inline-block max-w-[75%] align-middle",title:n,children:n}),a&&(0,u.jsxs)("span",{className:"text-gray-400 ml-2 text-xs align-middle",children:["[",a,"]"]})]},n+t)})})]}),(0,u.jsxs)("div",{children:[(0,u.jsx)("label",{className:"block text-xs font-semibold mb-1 text-gray-700",children:"JOVIE Names"}),(0,u.jsx)("input",{className:"mb-1 w-full border px-1 text-xs rounded focus:ring-2 focus:ring-blue-200",placeholder:"Search...",value:U,onChange:e=>J(e.target.value)}),(0,u.jsx)("ul",{id:"nameid-jovie-list",className:"border rounded h-40 overflow-y-auto bg-gray-50 text-sm",children:ae.map((e,t)=>{let{name:n,uid:a}=e;return(0,u.jsxs)("li",{className:"px-2 py-1 cursor-pointer hover:bg-green-100 "+(A===n?"bg-green-200":""),onClick:()=>E(n),title:n,children:[(0,u.jsx)("span",{className:"truncate inline-block max-w-[75%] align-middle",title:n,children:n}),a&&(0,u.jsxs)("span",{className:"text-gray-400 ml-2 text-xs align-middle",children:["[",a,"]"]})]},n+t)})})]})]}),(0,u.jsxs)("div",{className:"flex flex-col md:flex-row gap-2 mb-4 items-center",children:[(0,u.jsx)("input",{id:"nameid-old-input",className:"border px-2 py-1 text-xs rounded flex-1 min-w-[120px]",placeholder:"Old Name (BUCA)",value:I,onChange:e=>C(e.target.value)}),(0,u.jsx)("span",{className:"text-xl mx-2",children:"\u2192"}),(0,u.jsx)("input",{id:"nameid-preferred-input",className:"border px-2 py-1 text-xs rounded flex-1 min-w-[120px]",placeholder:"Preferred Name (JOVIE)",value:A,onChange:e=>E(e.target.value)}),(0,u.jsx)("button",{id:"nameid-assign-btn",className:"ml-2 px-4 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 disabled:opacity-50",onClick:function(){const e=m(I),t=m(A);if(!e||!t)return;const n=X(I),a=X(A),r=[b[n],b[a]].filter(Boolean),s=e=>"string"===typeof e&&/-MAST$/.test(e);let o;const i=Object.entries(b).filter(e=>{let[t,n]=e;return _(t)}).map(e=>{let[t,n]=e;return n});if(r.length>0){const e=r.find(s);if(e)o=e,w(e=>{let t={...e};return t[n]=o,t[a]=o,t=q(t,I,o),t=q(t,A,o),window.saveNameIdMap&&window.saveNameIdMap(t),f&&f(t),t});else if(2===r.length&&r[0]!==r[1]){const e=g(i,"MAST");w(t=>{let s={...t};const[o,i]=r;return Object.keys(s).forEach(t=>{!_(t)||s[t]!==o&&s[t]!==i||(s[t]=e)}),s[n]=e,s[a]=e,s=q(s,I,e),s=q(s,A,e),window.saveNameIdMap&&window.saveNameIdMap(s),f&&f(s),s})}else{const e=g(i,"MAST"),t=r[0];w(r=>{let s={...r};return Object.keys(s).forEach(n=>{_(n)&&s[n]===t&&(s[n]=e)}),s[n]=e,s[a]=e,s=q(s,I,e),s=q(s,A,e),window.saveNameIdMap&&window.saveNameIdMap(s),f&&f(s),s})}}else o=g(i,"MAST"),w(e=>{let t={...e,[n]:o,[a]:o};return t=q(t,I,o),t=q(t,A,o),window.saveNameIdMap&&window.saveNameIdMap(t),f&&f(t),t});C(""),E("")},disabled:!I||!A,children:"Assign ID"})]}),(0,u.jsx)("div",{id:"nameid-preview-label",className:"mb-4 text-xs text-gray-700 text-center min-h-[1.5em]",children:I&&A?`${I} \u2192 ${A}`:"Select or enter names to assign an ID."}),(0,u.jsxs)("div",{className:"mb-6",children:[(0,u.jsx)("label",{className:"block text-xs font-semibold mb-2 text-gray-700",children:"Assigned Name IDs"}),(0,u.jsx)("input",{className:"mb-2 w-full border px-1 text-xs rounded focus:ring-2 focus:ring-blue-200",placeholder:"Search assigned\u2026 (name or UID)",value:M,onChange:e=>$(e.target.value)}),(()=>{const e=(M||"").toLowerCase(),t=e?O.filter(t=>{let{names:n,uid:a}=t;return`${(n||[]).join(" ")} ${a||""}`.toLowerCase().includes(e)}):O;return(0,u.jsxs)("ul",{id:"nameid-id-list",className:"border rounded bg-gray-50 max-h-48 overflow-y-auto divide-y divide-gray-200",children:[0===t.length&&(0,u.jsx)("li",{className:"text-gray-400 italic px-2 py-1",children:"No assignments yet"}),t.map((e,t)=>{let{uid:n,names:a}=e;return(0,u.jsxs)("li",{className:"flex items-center px-2 py-2",children:[(0,u.jsxs)("span",{className:"flex-1 text-xs md:text-sm",children:[a.join(" | "),v&&(0,u.jsxs)("span",{className:"text-gray-400 ml-2",children:["[",n,"]"]})]}),(0,u.jsx)("button",{id:"nameid-delete-btn",className:"ml-2 text-red-500 hover:text-red-700 text-lg",title:"Delete all mappings for this ID",onClick:()=>function(e){w(t=>{const n={...t};return Object.keys(n).forEach(t=>{n[t]===e&&delete n[t]}),window.saveNameIdMap&&window.saveNameIdMap(n),f&&f(n),n})}(n),children:"\ud83d\uddd1\ufe0f"})]},n)})]})})()]}),(0,u.jsxs)("div",{className:"flex flex-col md:flex-row gap-2 mt-2 items-center",children:[(0,u.jsx)("button",{id:"nameid-save-btn",className:"px-4 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 w-full md:w-auto",onClick:async function(){try{let e=!1;try{e=await c(b)}catch{}const t=new Blob([JSON.stringify(b,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="name_id_map.json",a.click();try{S.publish("uids",{map:b,savedAt:(new Date).toISOString(),backend:e})}catch{}L(e?"Saved to backend and exported JSON":"Backend unavailable \u2014 saved locally and exported JSON"),setTimeout(()=>L(""),2500)}catch(e){L("Error saving"),setTimeout(()=>L(""),2500)}},children:"Save Assignments"}),(0,u.jsx)("span",{className:"text-xs px-2 py-1 rounded border w-full md:w-auto text-center "+(null===W?"text-gray-500 border-gray-300":W?"text-green-700 border-green-300 bg-green-50":"text-amber-700 border-amber-300 bg-amber-50"),title:W?"Backend connected: UID map will persist on server.":"Backend unavailable: falling back to local storage (map may be lost if cache is cleared).",children:null===W?"Checking backend\u2026":W?"Synced to backend":"Local-only (not synced)"}),x&&(0,u.jsx)("button",{id:"nameid-purge-btn",className:"px-4 py-2 bg-red-600 text-white rounded font-semibold hover:bg-red-700 w-full md:w-auto",onClick:async function(){try{await async function(){const e={},t=await l();try{t&&await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(n){}try{window.localStorage.removeItem(o),window.localStorage.removeItem(i)}catch{}return!0}();const e={};w(e),f&&f(e);try{window.saveNameIdMap&&window.saveNameIdMap(e)}catch{}try{S.publish("uids",{map:e,purgedAt:(new Date).toISOString()})}catch{}L("Registry purged"),setTimeout(()=>L(""),2e3)}catch(e){L("Error purging registry"),setTimeout(()=>L(""),2e3)}},children:"Purge Registry"})]}),B&&(0,u.jsx)("div",{className:"mt-2 text-green-700 text-xs text-center",children:B}),x&&(0,u.jsxs)("div",{className:"mt-6 text-xs text-gray-500 text-center",children:[(0,u.jsx)("b",{children:"Admin:"})," All assignments are local only. You can export/import as JSON.",(0,u.jsx)("br",{}),(0,u.jsx)("b",{children:"ID format:"})," UID-XXXX-SOURCE (MAST = both, BUCA, JOVIE).",(0,u.jsx)("br",{}),(0,u.jsx)("b",{children:"Tip:"})," Use the search boxes to quickly find names."]})]})})}"undefined"!==typeof window&&(window.saveNameIdMap=c)},636:(e,t,n)=>{n.d(t,{W:()=>a});const a=(0,n(131).v)((e,t)=>({channels:{buca:null,jovie:null,uids:null,storage:null},publish:(t,n)=>{e(e=>({channels:{...e.channels,[t]:{...e.channels[t],...n,timestamp:(new Date).toISOString()}}}))},subscribe:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e;return n=>a.subscribe(a=>{const r=a.channels[e];r&&n(t(r),r)},t)},clearChannel:t=>{e(e=>({channels:{...e.channels,[t]:null}}))},getChannelData:e=>t().channels[e]}));"undefined"!==typeof window&&(window.exchangeStore=a)}}]);
//# sourceMappingURL=241.bfb0e4ac.chunk.js.map
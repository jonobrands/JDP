"use strict";(self.webpackChunkcasecon_frontend=self.webpackChunkcasecon_frontend||[]).push([[510],{510:(e,t,n)=>{n.r(t),n.d(t,{ResultsPanel:()=>u,default:()=>d});var a=n(43),i=n(683),r=n(636);function l(e){return(e||"").trim().replace(/\s+/g," ").toLowerCase()}var s=n(526),o=n(579);function c(e){let{rows:t=[],onClearResults:c,onExport:d,onResultEdit:u}=e;const h=(0,r.W)(),[m,g]=a.useState("12h"),v=(0,s.Q)(e=>e.editedValues),p=(0,s.Q)(e=>e.setEditedValue),x=(0,s.Q)(e=>e.clearEditedValues),b=(0,s.Q)(e=>e.clearDeviationMessages),f=(0,s.Q)(e=>e.setDeviationMessages),y="timeck_display_mode",C=a.useCallback(e=>{try{if(!e)return;const t=document.createRange();t.selectNodeContents(e);const n=window.getSelection();if(!n)return;n.removeAllRanges(),n.addRange(t)}catch{}},[]);a.useEffect(()=>{try{const e=localStorage.getItem(y);"12h"!==e&&"24h"!==e||g(e)}catch{}},[]),a.useEffect(()=>{try{localStorage.setItem(y,m)}catch{}},[m]);const j=h.getChannelData?h.getChannelData("jovie"):null,$=Array.isArray(null===j||void 0===j?void 0:j.rows)?j.rows:[],{nameMap:_,uidMap:N,mastMap:w,mastDateMap:E}=a.useMemo(()=>{const e=new Map,t=new Map,n=new Map,a=new Map,i=e=>Boolean(e&&(e.timeRange||e.time||e.start_time&&e.end_time)),r=e=>(null===e||void 0===e?void 0:e.date)||(null===e||void 0===e?void 0:e.service_date)||(null===e||void 0===e?void 0:e.SERVICE_DATE)||(null===e||void 0===e?void 0:e.Date);for(const s of $){const o=`${l(s.client||"")}|${l(s.caregiver||"")}`,c=e.get(o);(!c||!i(c)&&i(s))&&e.set(o,s);const d=s.clientUID||s.client_uid||s.CLIENT_UID,u=s.caregiverUID||s.caregiver_uid||s.CAREGIVER_UID;if(d&&u){const e=`${d}|${u}`,n=t.get(e);(!n||!i(n)&&i(s))&&t.set(e,s)}const h=s.mast_uid||s.MAST_UID||s.master_uid||s.MASTER_UID||s.pair_uid||s.pairUID;if(h){const e=String(h),t=n.get(e);(!t||!i(t)&&i(s))&&n.set(e,s);const l=r(s);if(l){const t=`${e}|${l}`,n=a.get(t);(!n||!i(n)&&i(s))&&a.set(t,s)}}}return{nameMap:e,uidMap:t,mastMap:n,mastDateMap:a}},[$]),M=e=>(null===e||void 0===e?void 0:e.mast_uid)||(null===e||void 0===e?void 0:e.MAST_UID)||(null===e||void 0===e?void 0:e.master_uid)||(null===e||void 0===e?void 0:e.MASTER_UID)||(null===e||void 0===e?void 0:e.pair_uid)||(null===e||void 0===e?void 0:e.pairUID),D=(e,t,n)=>{let a=parseInt(e,10);const i=parseInt(t,10)||0,r=(n||"").toLowerCase();return"pm"===r&&12!==a&&(a+=12),"am"===r&&12===a&&(a=0),60*a+i},I=e=>{const t=Math.abs(e),n=Math.floor(t/60),a=t%60;return n>0?`${n}h ${a}m`:`${a}m`},T=e=>{if(!e||"string"!==typeof e)return null;const t=String(e).trim();let n=t.match(/\b(\d{1,2})(?::(\d{2}))?\s*([ap]m)\b\s*[-\u2013]\s*\b(\d{1,2})(?::(\d{2}))?\s*([ap]m)\b/i);if(n){var a,i;const e=D(n[1],null!==(a=n[2])&&void 0!==a?a:"00",n[3]);let t=D(n[4],null!==(i=n[5])&&void 0!==i?i:"00",n[6]);return t<=e&&(t+=1440),{start:e,end:t}}if(n=t.match(/\b(\d{1,2}):(\d{2})\b\s*[-\u2013]\s*\b(\d{1,2}):(\d{2})\b/),n){const e=(e,t)=>60*Math.min(23,Math.max(0,parseInt(e,10)))+Math.min(59,Math.max(0,parseInt(t,10))),t=e(n[1],n[2]);let a=e(n[3],n[4]);return a<=t&&(a+=1440),{start:t,end:a}}return null},R=(e,t)=>{const n=T(e),a=T(t);if(!n||!a)return{badge:"",color:"",severity:"none"};const i=a.start-n.start,r=a.end-n.end;if(0===i&&0===r)return{badge:"YES",color:"green",severity:"ok",details:[]};const l=[];i<0&&l.push(`Arrived early ${I(i)}`),i>0&&l.push(`Arrived late ${I(i)}`),r<0&&l.push(`Left early ${I(r)}`),r>0&&l.push(`Left late ${I(r)}`);return Math.abs(i)>60||Math.abs(r)>60?{badge:`More than hour deviation: ${l.join(", ")}`,color:"red",severity:"bad",details:l}:{badge:l.join(", "),color:"orange",severity:"warn",details:l}},S=e=>{const t=(e%1440+1440)%1440,n=t%60,a=e=>e<10?`0${e}`:`${e}`;return`${a(Math.floor(t/60))}:${a(n)}`},k=e=>{const t=(e%1440+1440)%1440;let n=Math.floor(t/60);const a=n>=12?"pm":"am";n%=12,0===n&&(n=12);return`${n}:${i=t%60,i<10?`0${i}`:`${i}`} ${a}`;var i},U=(e,t)=>{const n=T(e);if(!n)return"24h"===t?e:(0,i.$)(e);const{start:a,end:r}=n;return"24h"===t?`${S(a)} - ${S(r)}`:`${k(a)} - ${k(r)}`},A=e=>(null===e||void 0===e?void 0:e.date)||(null===e||void 0===e?void 0:e.service_date)||(null===e||void 0===e?void 0:e.SERVICE_DATE)||(null===e||void 0===e?void 0:e.Date),O=e=>(null===e||void 0===e?void 0:e.timeRange)||(null===e||void 0===e?void 0:e.time)||(null!==e&&void 0!==e&&e.start_time&&null!==e&&void 0!==e&&e.end_time?`${e.start_time}-${e.end_time}`:void 0),L=e=>{var t;const n=e.timeRange||e.time,a=(e=>(null===e||void 0===e?void 0:e.clientUID)||(null===e||void 0===e?void 0:e.clientUid)||(null===e||void 0===e?void 0:e.client_id)||(null===e||void 0===e?void 0:e.clientId)||(null===e||void 0===e?void 0:e.client_uid)||(null===e||void 0===e?void 0:e.CLIENT_UID)||(null===e||void 0===e?void 0:e.uid_client)||(null===e||void 0===e?void 0:e.CLIENTID)||(null===e||void 0===e?void 0:e.CLIENT))(e),i=(e=>(null===e||void 0===e?void 0:e.caregiverUID)||(null===e||void 0===e?void 0:e.caregiverUid)||(null===e||void 0===e?void 0:e.caregiver_id)||(null===e||void 0===e?void 0:e.caregiverId)||(null===e||void 0===e?void 0:e.caregiver_uid)||(null===e||void 0===e?void 0:e.CAREGIVER_UID)||(null===e||void 0===e?void 0:e.uid_caregiver)||(null===e||void 0===e?void 0:e.CAREGIVERID)||(null===e||void 0===e?void 0:e.CAREGIVER))(e);if(a&&i){const e=N.get(`${a}|${i}`),t=O(e);if(t)return t}const r=M(e);if(r){const t=String(r),n=A(e);if(n){const e=E.get(`${t}|${n}`),a=O(e);if(a)return a}const a=w.get(t),i=O(a);if(i)return i}const s=[e.client],o=(c=null!==(t=e.caregivers)&&void 0!==t?t:e.caregiver,Array.isArray(c)?c:"string"===typeof c?c.split(",").map(e=>e.trim()).filter(Boolean):[c].filter(Boolean));var c;for(const d of s)for(const e of o){const t=`${l(d||"")}|${l(e||"")}`,n=_.get(t),a=O(n);if(a)return a}if(!n){const t=M(e);console.warn("[TimeCK] No JOVIE time found",{client:e.client,caregiver:e.caregiver,date:A(e),mast:t})}return n},V=t.filter(e=>"exact_match"===e.tag||"Exact Match"===e.match_type||1===e.confidence||1===e.confidence),K=t.filter(e=>"mismatch"===e.tag||"Mismatch"===e.match_type||"Missing"===e.match_type||"BUCA only"===e.source||"JOVIE only"===e.source),[J,P]=a.useState(!1),F=a.useCallback(()=>({exact:V.map(e=>{const n=(0,i.$)(L(e))||"",a=(e=>{const n=t.indexOf(e);return(n in v?v[n]:void 0)||e.result||e.timeChecked||""})(e),r=t.indexOf(e),l=R(n,a);return{Pair:e.pair||e.uid||e.UID||"",Client:e.client||"",Caregiver:e.caregiver||"",Date:e.date||"",JOVIE_Time:n,Result_Time:a,Deviation:B&&B[r]||l.badge||l.message||""}}),missing:K.map(e=>({Pair:e.pair||e.uid||e.UID||"",Client:e.client||"",Caregiver:e.caregiver||"",Date:e.date||"",JOVIE_Time:(0,i.$)(L(e))||""}))}),[v,t,V,K]),B=a.useMemo(()=>{try{const e={};if(!Array.isArray(V))return e;for(const n of V){const a=t.indexOf(n);if(a<0)continue;const r=(a in v?v[a]:void 0)||n.result||n.timeChecked||"",l=(0,i.$)(L(n))||"",s=R(l,r)||{};e[a]=s.badge||""}return e}catch{return{}}},[V,t,v]);a.useEffect(()=>{try{f(B)}catch{}},[B,f]);const Q=(e,t)=>{if(!t.length)return;const n=Object.keys(t[0]),a=[n.join(","),...t.map(e=>n.map(t=>(e=>{if(null==e)return"";const t=String(e);return/[",\n]/.test(t)?'"'+t.replace(/"/g,'""')+'"':t})(e[t])).join(","))].join("\n"),i=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(i),l=document.createElement("a");l.href=r,l.download=e,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r)};return(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{className:"flex items-center justify-between gap-4 mb-4",children:[(0,o.jsxs)("div",{className:"flex gap-3",children:[(0,o.jsx)("button",{className:"bg-gray-300 text-gray-800 px-6 py-2 rounded font-semibold hover:bg-gray-400",onClick:async()=>{const{exact:e,missing:t}=F();try{const a=await n.e(287).then(n.t.bind(n,287,23)),i=a&&a.default?a.default:a,r=await i.fromBlankAsync();let l=r.sheet("Exact")||r.addSheet("Exact"),s=r.sheet("Missing")||r.addSheet("Missing");const o=r.sheet("Sheet1");o&&"Exact"!==o.name()&&"Missing"!==o.name()&&r.deleteSheet(o);const c=["Pair","Client","Caregiver","Date","JOVIE_Time"],d=(e,t,n)=>{e.cell(1,1).value([t]),e.range(1,1,1,t.length).style({bold:!0,fill:"DDDDDD",horizontalAlignment:"center"}),n.forEach((n,a)=>{const i=a+2;t.forEach((t,a)=>{const r=a+1;e.cell(i,r).value(null==n[t]?"":n[t])})});const a=(n.length||0)+1,i=t.length,r=t.indexOf("Deviation");-1!==r&&n.forEach((t,n)=>{const a=n+2,i=t.JOVIE_Time||"",l=t.Result_Time||"",s=((R(i,l)||{}).color||"").toLowerCase();let o,c={};"green"===s?o="C6EFCE":"orange"===s?o="FCE4D6":"red"===s&&(o="FFC7CE",c={fontColor:"9C0006",bold:!0}),o&&e.cell(a,r+1).style({fill:o,...c})});const l=t.indexOf("Date");if(-1!==l&&n.length>0)try{e.range(2,l+1,a,l+1).style("numberFormat","yyyy-mm-dd")}catch{}try{e.range(1,1,a,i).style("border","thin")}catch{}try{e.freezePanes(1,0)}catch{}for(let s=0;s<t.length;s++){const a=t[s];let i=String(a).length;n.forEach(e=>{const t=String(null==e[a]?"":e[a]);i=Math.max(i,t.length)});const r=Math.min(60,i+2);e.column(s+1).width(r)}};d(l,["Pair","Client","Caregiver","Date","JOVIE_Time","Result_Time","Deviation"],e),d(s,c,t);const u=await r.outputAsync(),h=URL.createObjectURL(u),m=document.createElement("a");return m.href=h,m.download="CaseConTimeCK.xlsx",document.body.appendChild(m),m.click(),document.body.removeChild(m),void URL.revokeObjectURL(h)}catch(a){console.warn("[TimeCK] xlsx-populate not available, falling back to SheetJS (no colors)",a)}try{const a=await n.e(238).then(n.bind(n,238)),i=a&&a.default?a.default:a,r=i.utils.book_new(),l=i.utils.json_to_sheet(e),s=i.utils.json_to_sheet(t),o=e=>(e&&e.length?Object.keys(e[0]):[]).map(t=>{const n=String(t).length,a=(e||[]).reduce((e,n)=>{const a=n&&Object.prototype.hasOwnProperty.call(n,t)?n[t]:"",i=null==a?"":String(a);return Math.max(e,i.length)},0);return{wch:Math.min(60,Math.max(n,a)+2)}});return l["!cols"]=o(e),s["!cols"]=o(t),i.utils.book_append_sheet(r,l,"Exact"),i.utils.book_append_sheet(r,s,"Missing"),void i.writeFile(r,"CaseConTimeCK.xlsx")}catch(a){console.warn("[TimeCK] XLSX export failed, exporting CSV instead",a)}try{const n=[...e.map(e=>({Table:"Exact",...e})),...t.map(e=>({Table:"Missing",...e}))];Q("CaseConTimeCK.csv",n)}catch(a){console.error("[TimeCK] CSV export failed",a)}},children:"Export"}),(0,o.jsx)("button",{className:"bg-orange-500 text-white px-6 py-2 rounded font-semibold hover:bg-orange-600",onClick:()=>{try{x(),b()}catch{}"function"===typeof c&&c()},children:"Clear Results"})]}),(0,o.jsxs)("div",{className:"text-sm text-gray-700",children:[(0,o.jsx)("span",{className:"font-semibold",children:"Exact Matches:"})," ",(0,o.jsx)("span",{className:"inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 font-semibold mr-2",children:V.length}),(0,o.jsx)("span",{className:"font-semibold",children:"Missing:"})," ",(0,o.jsx)("button",{type:"button",className:"inline-block px-2 py-0.5 rounded font-semibold mr-2 "+(J?"bg-yellow-200 text-yellow-900":"bg-gray-200 text-gray-700 hover:bg-gray-300"),onClick:()=>P(e=>!e),title:"Click to view missing lines",children:K.length}),(0,o.jsx)("span",{className:"ml-2 mr-1 font-semibold",children:"Display:"}),(0,o.jsxs)("div",{className:"inline-flex border rounded overflow-hidden align-middle",children:[(0,o.jsx)("button",{className:"px-2 py-0.5 text-xs font-semibold "+("12h"===m?"bg-blue-600 text-white":"bg-white text-gray-700 hover:bg-gray-100"),onClick:()=>g("12h"),children:"12h"}),(0,o.jsx)("button",{className:"px-2 py-0.5 text-xs font-semibold "+("24h"===m?"bg-blue-600 text-white":"bg-white text-gray-700 hover:bg-gray-100"),onClick:()=>g("24h"),children:"24h"})]})]})]}),(0,o.jsx)("div",{className:"overflow-x-auto border rounded bg-white mb-2 output-scroll",children:(0,o.jsxs)("table",{className:"min-w-full text-sm",children:[(0,o.jsx)("thead",{className:"bg-gray-200",children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{className:"p-2 font-bold",children:"Line #"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Client"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Caregiver"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Time"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Result"})]})}),(0,o.jsx)("tbody",{children:0===V.length?(0,o.jsx)("tr",{children:(0,o.jsx)("td",{className:"p-4 text-center text-gray-500",colSpan:5,children:"No exact matches yet. Run Compare to generate results."})}):V.map((e,n)=>{const a=t.indexOf(e),r=(a in v?v[a]:void 0)||e.result||e.timeChecked||"",l=(0,i.$)(L(e))||"",s=R(l,r),c="green"===s.color?"bg-green-50":"red"===s.color?"bg-red-200":"orange"===s.color?"bg-orange-50":"",d="green"===s.color?"text-green-700":"red"===s.color?"text-red-800":"orange"===s.color?"text-orange-700":"text-gray-600";return(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{className:"p-2",children:e.line||n+1}),(0,o.jsx)("td",{className:"p-2",children:e.client}),(0,o.jsx)("td",{className:"p-2",children:e.caregiver}),(0,o.jsx)("td",{className:"p-2",children:U(L(e),m)}),(0,o.jsxs)("td",{className:`p-2 ${c}`,children:[(0,o.jsx)("div",{role:"textbox",contentEditable:!0,suppressContentEditableWarning:!0,onPaste:e=>{try{const i=(e.clipboardData||window.clipboardData).getData("text");if(!i)return;e.preventDefault();let r=i.match(/\b(\d{1,2})(?::(\d{2}))?\s*([ap]m)\b\s*[-\u2013]\s*\b(\d{1,2})(?::(\d{2}))?\s*([ap]m)\b/i);if(r){var t,n;const i=D(r[1],null!==(t=r[2])&&void 0!==t?t:"00",r[3]);let l=D(r[4],null!==(n=r[5])&&void 0!==n?n:"00",r[6]);l<=i&&(l+=1440);const s=`${k(i)} - ${k(l)}`,o="24h"===m?`${S(i)} - ${S(l)}`:s;return e.currentTarget&&(e.currentTarget.textContent=o),a>=0&&p(a,s),void("function"===typeof u&&a>=0&&u(a,s))}if(r=i.match(/\b(\d{1,2}):(\d{2})\b\s*[-\u2013]\s*\b(\d{1,2}):(\d{2})\b/),r){const t=(e,t)=>60*Math.min(23,Math.max(0,parseInt(e,10)))+Math.min(59,Math.max(0,parseInt(t,10))),n=t(r[1],r[2]);let i=t(r[3],r[4]);i<=n&&(i+=1440);const l=`${k(n)} - ${k(i)}`,s="24h"===m?`${S(n)} - ${S(i)}`:l;return e.currentTarget&&(e.currentTarget.textContent=s),a>=0&&p(a,l),void("function"===typeof u&&a>=0&&u(a,l))}}catch{}},onKeyDown:async e=>{try{if(!((e.ctrlKey||e.metaKey)&&("v"===e.key||"V"===e.key)))return;if(navigator.clipboard&&navigator.clipboard.readText){const i=await navigator.clipboard.readText();if(!i)return;e.preventDefault();let r=i.match(/\b(\d{1,2})(?::(\d{2}))?\s*([ap]m)\b\s*[-\u2013]\s*\b(\d{1,2})(?::(\d{2}))?\s*([ap]m)\b/i);if(r){var t,n;const i=D(r[1],null!==(t=r[2])&&void 0!==t?t:"00",r[3]);let l=D(r[4],null!==(n=r[5])&&void 0!==n?n:"00",r[6]);l<=i&&(l+=1440);const s=`${k(i)} - ${k(l)}`,o="24h"===m?`${S(i)} - ${S(l)}`:s;return e.currentTarget&&(e.currentTarget.textContent=o),a>=0&&p(a,s),void("function"===typeof u&&a>=0&&u(a,s))}if(r=i.match(/\b(\d{1,2}):(\d{2})\b\s*[-\u2013]\s*\b(\d{1,2}):(\d{2})\b/),r){const t=(e,t)=>60*Math.min(23,Math.max(0,parseInt(e,10)))+Math.min(59,Math.max(0,parseInt(t,10))),n=t(r[1],r[2]);let i=t(r[3],r[4]);i<=n&&(i+=1440);const l=`${k(n)} - ${k(i)}`,s="24h"===m?`${S(n)} - ${S(i)}`:l;return e.currentTarget&&(e.currentTarget.textContent=s),a>=0&&p(a,l),void("function"===typeof u&&a>=0&&u(a,l))}}}catch{}},onFocus:e=>C(e.currentTarget),onClick:e=>C(e.currentTarget),className:"min-w-[180px] px-2 py-1 border rounded focus:outline-none focus:ring-2 focus:ring-orange-400",children:r?U(r,m):""}),s.badge?(0,o.jsx)("div",{className:`mt-1 text-xs font-semibold ${d}`,children:s.badge}):null]})]},n)})})]})}),J&&(0,o.jsxs)("div",{className:"mt-4",children:[(0,o.jsx)("div",{className:"text-sm text-gray-700 font-semibold mb-2",children:"Missing items"}),(0,o.jsx)("div",{className:"overflow-x-auto border rounded bg-white output-scroll",children:(0,o.jsxs)("table",{className:"min-w-full text-sm",children:[(0,o.jsx)("thead",{className:"bg-gray-200",children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{className:"p-2 font-bold",children:"Line #"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Client"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Caregiver"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Date"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Time"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Source"}),(0,o.jsx)("th",{className:"p-2 font-bold",children:"Type"})]})}),(0,o.jsx)("tbody",{children:0===K.length?(0,o.jsx)("tr",{children:(0,o.jsx)("td",{className:"p-4 text-center text-gray-500",colSpan:7,children:"No missing items."})}):K.map((e,t)=>(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{className:"p-2",children:e.line||t+1}),(0,o.jsx)("td",{className:"p-2",children:e.client}),(0,o.jsx)("td",{className:"p-2",children:e.caregiver}),(0,o.jsx)("td",{className:"p-2",children:e.date||""}),(0,o.jsx)("td",{className:"p-2",children:U(L(e),m)}),(0,o.jsx)("td",{className:"p-2",children:e.source||""}),(0,o.jsx)("td",{className:"p-2",children:e.match_type||e.tag||""})]},t))})]})})]})]})}const d=c,u=c},636:(e,t,n)=>{n.d(t,{W:()=>a});const a=(0,n(131).v)((e,t)=>({channels:{buca:null,jovie:null,uids:null,storage:null},publish:(t,n)=>{e(e=>({channels:{...e.channels,[t]:{...e.channels[t],...n,timestamp:(new Date).toISOString()}}}))},subscribe:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e;return n=>a.subscribe(a=>{const i=a.channels[e];i&&n(t(i),i)},t)},clearChannel:t=>{e(e=>({channels:{...e.channels,[t]:null}}))},getChannelData:e=>t().channels[e]}));"undefined"!==typeof window&&(window.exchangeStore=a)}}]);
//# sourceMappingURL=510.8a49db8b.chunk.js.map